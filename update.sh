#!/bin/bash

# Update fork with upstream changes
# This script fetches the latest changes from upstream and merges them into the current branch

set -e

UPSTREAM_REMOTE="upstream"
UPSTREAM_BRANCH="main"
ORIGIN_REMOTE="origin"

echo "üîÑ Updating fork with upstream changes..."

# Check if upstream remote exists
if ! git remote | grep -q "^${UPSTREAM_REMOTE}$"; then
    echo "‚ùå Upstream remote '${UPSTREAM_REMOTE}' not found."
    echo "Add it with: git remote add upstream https://github.com/vicinaehq/vicinae.git"
    exit 1
fi

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "üìç Current branch: ${CURRENT_BRANCH}"

# Fetch latest changes from upstream
echo "‚¨áÔ∏è  Fetching latest changes from upstream..."
git fetch ${UPSTREAM_REMOTE}

# Check if there are new commits in upstream
NEW_COMMITS=$(git log --oneline ${CURRENT_BRANCH}..${UPSTREAM_REMOTE}/${UPSTREAM_BRANCH} | wc -l)

if [ "${NEW_COMMITS}" -eq 0 ]; then
    echo "‚úÖ Already up to date with upstream!"
    exit 0
fi

echo "üì¶ Found ${NEW_COMMITS} new commit(s) in upstream"

# Show what commits will be merged
echo "üìã New commits:"
git log --oneline --graph ${CURRENT_BRANCH}..${UPSTREAM_REMOTE}/${UPSTREAM_BRANCH}

# Confirm before merging
read -p "ü§î Merge these changes? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Aborted"
    exit 0
fi

# Merge upstream changes
echo "üîÑ Merging upstream changes..."
git merge ${UPSTREAM_REMOTE}/${UPSTREAM_BRANCH}

# Push to origin
read -p "üì§ Push merged changes to your fork? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "‚¨ÜÔ∏è  Pushing to ${ORIGIN_REMOTE}..."
    git push ${ORIGIN_REMOTE} ${CURRENT_BRANCH}
    echo "‚úÖ Fork updated successfully!"
else
    echo "‚ö†Ô∏è  Changes merged locally but not pushed to fork"
fi